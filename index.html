<!DOCTYPE html>
<html lang="fr" class="dark">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Vivre√Ä ‚Äì D√©couvrez votre prochaine commune</title>
  <meta name="description" content="Base de donn√©es exhaustive des 35 000 communes fran√ßaises. Prix immobilier, couverture fibre, carburants et bien plus." />
  <meta property="og:title" content="Vivre√Ä ‚Äì Toutes les communes fran√ßaises" />
  <meta property="og:description" content="Explorez les 35 000 communes de France : immobilier, fibre, carburants." />
  <meta property="og:type" content="website" />
  <meta property="og:url" content="https://vivrea.vox-novalys.fr/" />
  <link rel="canonical" href="https://vivrea.vox-novalys.fr/" />

  <script src="https://cdn.tailwindcss.com"></script>
  <script>
    tailwind.config = {
      darkMode: 'class',
      theme: {
        extend: {
          colors: { surface: '#111111', card: '#1a1a1a', border: '#2a2a2a' },
          fontFamily: { sans: ['Inter', 'system-ui', 'sans-serif'] },
        },
      },
    };
  </script>
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
  <script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-2156803616781959" crossorigin="anonymous"></script>

  <style>
    body { background: #0a0a0a; }
    ::-webkit-scrollbar { width: 6px; }
    ::-webkit-scrollbar-track { background: #0a0a0a; }
    ::-webkit-scrollbar-thumb { background: #333; border-radius: 3px; }

    @keyframes fadeUp {
      from { opacity:0; transform:translateY(12px); }
      to   { opacity:1; transform:translateY(0); }
    }
    .fade-up { animation: fadeUp .35s ease forwards; }

    .search-input:focus { box-shadow: 0 0 0 2px #6366f1, 0 0 24px rgba(99,102,241,.18); }
    .bento-card { transition: transform .2s ease, box-shadow .2s ease; }
    .bento-card:hover { transform: translateY(-2px); box-shadow: 0 8px 32px rgba(99,102,241,.12); }

    @keyframes shimmer {
      0%   { background-position: -400px 0; }
      100% { background-position:  400px 0; }
    }
    .skeleton {
      background: linear-gradient(90deg, #1a1a1a 25%, #252525 50%, #1a1a1a 75%);
      background-size: 400px 100%;
      animation: shimmer 1.4s infinite;
      border-radius: 6px;
    }
    .suggestion-item:hover, .suggestion-item.active { background: rgba(99,102,241,.15); }
    .badge { font-size:.65rem; padding:2px 8px; border-radius:999px; font-weight:600; letter-spacing:.03em; }
    .bar-fill { transition: width .7s cubic-bezier(.16,1,.3,1); }
    .amzn-card { background: linear-gradient(135deg,rgba(255,153,0,.06),rgba(99,102,241,.06)); border:1px solid rgba(255,153,0,.2); }

    /* S√©parateur colonne comparaison */
    #city-details-1.in-compare { border-right: 1px solid #2a2a2a; padding-right: 1.5rem; }
    @media (max-width: 1023px) {
      #city-details-1.in-compare { border-right: none; border-bottom: 1px solid #2a2a2a; padding-right: 0; padding-bottom: 1.5rem; margin-bottom: 1.5rem; }
    }
  </style>
</head>

<body class="text-gray-200 font-sans antialiased min-h-screen" style="background:#0a0a0a">

  <!-- ‚ïê‚ïê HEADER ‚ïê‚ïê -->
  <header class="sticky top-0 z-40 border-b border-border" style="background:rgba(10,10,10,.9);backdrop-filter:blur(14px)">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 h-14 flex items-center justify-between">
      <a href="/" onclick="navigate('/',event)" class="flex items-center gap-2 shrink-0">
        <span class="text-indigo-500 text-xl font-black leading-none">V</span>
        <span class="font-semibold text-white text-sm">Vivre<span class="text-indigo-400">√Ä</span></span>
      </a>
      <nav class="hidden sm:flex items-center gap-6 text-xs text-gray-400">
        <a href="/"           onclick="navigate('/',event)"        class="hover:text-indigo-400 transition-colors">Accueil</a>
        <a href="/explorer.html"                                    class="hover:text-indigo-400 transition-colors">Explorer</a>
        <a href="/a-propos"   onclick="navigate('/a-propos',event)" class="hover:text-indigo-400 transition-colors">√Ä propos</a>
      </nav>
      <div id="worker-status" class="hidden sm:flex items-center gap-1.5 text-xs text-gray-600">
        <span class="w-1.5 h-1.5 rounded-full bg-gray-600 animate-pulse"></span>Chargement‚Ä¶
      </div>
    </div>
  </header>

  <!-- ‚ïê‚ïê MAIN ‚ïê‚ïê -->
  <main id="app" class="max-w-7xl mx-auto px-4 sm:px-6 py-8"></main>

  <!-- ‚ïê‚ïê FOOTER ‚ïê‚ïê -->
  <footer class="border-t border-border mt-16 py-8 text-center text-xs text-gray-600">
    <p>¬© 2025 Vivre√Ä ¬∑ <a href="https://geo.api.gouv.fr" class="text-indigo-500 hover:underline" target="_blank">API G√©o</a> ¬∑ <a href="https://etalab.gouv.fr" class="text-indigo-500 hover:underline" target="_blank">√âtalab</a> ¬∑ <a href="https://arcep.fr" class="text-indigo-500 hover:underline" target="_blank">ARCEP</a></p>
    <p class="mt-1">Partenaire Amazon vivrea-21. <a href="/mentions-legales" onclick="navigate('/mentions-legales',event)" class="text-indigo-500 hover:underline">Mentions l√©gales</a></p>
  </footer>

  <!-- ‚ïê‚ïê TEMPLATES ‚ïê‚ïê -->
  <template id="tpl-home">
    <section class="text-center py-14 fade-up">
      <div class="inline-flex items-center gap-2 bg-indigo-500/10 border border-indigo-500/20 rounded-full px-4 py-1 text-xs text-indigo-400 mb-6">
        <span class="w-1.5 h-1.5 rounded-full bg-indigo-400 animate-pulse"></span>
        35 000 communes ¬∑ Donn√©es mises √† jour chaque semaine
      </div>
      <h1 class="text-4xl sm:text-5xl lg:text-6xl font-bold text-white mb-3 tracking-tight leading-tight">
        Trouvez votre prochaine<br/>
        <span class="text-transparent bg-clip-text bg-gradient-to-r from-indigo-400 to-purple-400">commune id√©ale</span>
      </h1>
      <p class="text-gray-400 text-base max-w-2xl mx-auto mb-10">Immobilier, fibre optique, carburants, d√©mographie ‚Äî toutes les donn√©es pour bien choisir o√π <em>vivre</em>.</p>

      <div class="relative max-w-2xl mx-auto" id="search-container">
        <div class="relative">
          <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
            <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
          </span>
          <input id="search-input" type="search" autocomplete="off" spellcheck="false"
            class="search-input w-full bg-card border border-border rounded-2xl pl-11 pr-4 py-4 text-sm text-white placeholder-gray-500 outline-none transition-all"
            placeholder="Commune, code postal, code INSEE‚Ä¶" />
          <span id="search-loader" class="absolute right-4 top-1/2 -translate-y-1/2 hidden">
            <svg class="animate-spin w-4 h-4 text-indigo-400" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"/><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"/></svg>
          </span>
        </div>
        <ul id="search-dropdown" class="hidden absolute z-50 w-full mt-1.5 bg-card border border-border rounded-2xl overflow-hidden shadow-2xl"></ul>
      </div>

      <div class="grid grid-cols-3 gap-4 max-w-sm mx-auto mt-10 text-xs text-gray-500">
        <div><span class="block text-2xl font-bold text-white" id="stat-communes">‚Äî</span>communes</div>
        <div><span class="block text-2xl font-bold text-white">101</span>d√©partements</div>
        <div><span class="block text-2xl font-bold text-white">18</span>r√©gions</div>
      </div>
    </section>

    <div class="my-6 flex justify-center overflow-hidden">
      <ins class="adsbygoogle" style="display:block;width:728px;height:90px;max-width:100%"
           data-ad-client="ca-pub-2156803616781959" data-ad-slot="auto" data-ad-format="horizontal" data-full-width-responsive="true"></ins>
    </div>

    <section class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 mt-4">
      <div class="bento-card lg:col-span-2 bg-card border border-border rounded-2xl p-6 flex gap-4">
        <div class="w-10 h-10 rounded-xl bg-indigo-500/15 flex items-center justify-center text-indigo-400 shrink-0 mt-1">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>
        </div>
        <div>
          <span class="badge bg-indigo-500/20 text-indigo-300 mb-2 inline-block">IMMOBILIER</span>
          <h2 class="text-base font-semibold text-white mb-1">Prix m¬≤ r√©els (DVF)</h2>
          <p class="text-sm text-gray-400 leading-relaxed">Demandes de Valeurs Fonci√®res agr√©g√©es ‚Äî transactions r√©elles, pas des estimations.</p>
        </div>
      </div>
      <div class="bento-card bg-card border border-border rounded-2xl p-6">
        <div class="w-9 h-9 rounded-xl bg-emerald-500/15 flex items-center justify-center text-emerald-400 mb-3">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07A19.5 19.5 0 0 1 4.69 12 19.79 19.79 0 0 1 1.61 3.41 2 2 0 0 1 3.6 1.21h3a2 2 0 0 1 2 1.72c.127.96.361 1.903.7 2.81a2 2 0 0 1-.45 2.11L7.91 8.91a16 16 0 0 0 6 6l.86-.86a2 2 0 0 1 2.11-.45c.907.339 1.85.573 2.81.7A2 2 0 0 1 22 16.92z"/></svg>
        </div>
        <span class="badge bg-emerald-500/20 text-emerald-300 mb-2 inline-block">FIBRE FTTH</span>
        <h2 class="text-base font-semibold text-white mb-1">Couverture ARCEP</h2>
        <p class="text-sm text-gray-400">Taux de locaux raccordables, source officielle.</p>
      </div>
      <div class="bento-card bg-card border border-border rounded-2xl p-6">
        <div class="w-9 h-9 rounded-xl bg-amber-500/15 flex items-center justify-center text-amber-400 mb-3">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13 5.4 5M7 13l-2 9h14l-2-9"/></svg>
        </div>
        <span class="badge bg-amber-500/20 text-amber-300 mb-2 inline-block">CARBURANT</span>
        <h2 class="text-base font-semibold text-white mb-1">Prix instantan√©s</h2>
        <p class="text-sm text-gray-400">Flux temps r√©el des prix √† la pompe.</p>
      </div>
      <div class="bento-card bg-card border border-border rounded-2xl p-6">
        <div class="w-9 h-9 rounded-xl bg-purple-500/15 flex items-center justify-center text-purple-400 mb-3">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87M16 3.13a4 4 0 0 1 0 7.75"/></svg>
        </div>
        <span class="badge bg-purple-500/20 text-purple-300 mb-2 inline-block">D√âMOGRAPHIE</span>
        <h2 class="text-base font-semibold text-white mb-1">Population INSEE</h2>
        <p class="text-sm text-gray-400">Surface, densit√©, d√©partement.</p>
      </div>
      <div class="bento-card lg:col-span-2 bg-gradient-to-br from-indigo-500/10 to-purple-500/10 border border-indigo-500/20 rounded-2xl p-6 flex gap-4">
        <div class="w-10 h-10 rounded-xl bg-indigo-500/15 flex items-center justify-center text-indigo-400 shrink-0 mt-1">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="18" rx="1"/></svg>
        </div>
        <div>
          <span class="badge bg-indigo-500/20 text-indigo-300 mb-2 inline-block">COMPARAISON</span>
          <h2 class="text-base font-semibold text-white mb-1">Mode Comparaison c√¥te √† c√¥te</h2>
          <p class="text-sm text-gray-400 mb-3">Ouvrez une fiche commune, cliquez <strong class="text-indigo-300">Comparer</strong> ‚Äî une deuxi√®me colonne appara√Æt √† droite pour choisir une autre ville.</p>
          <a href="/explorer.html" class="inline-block text-xs bg-indigo-600 hover:bg-indigo-500 text-white px-4 py-1.5 rounded-lg transition-colors font-medium">Explorer toutes les communes ‚Üí</a>
        </div>
      </div>
      <div class="bento-card bg-card border border-border rounded-2xl p-6">
        <div class="w-9 h-9 rounded-xl bg-rose-500/15 flex items-center justify-center text-rose-400 mb-3">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M2 12h20M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10A15.3 15.3 0 0 1 12 2z"/></svg>
        </div>
        <span class="badge bg-rose-500/20 text-rose-300 mb-2 inline-block">OPEN DATA</span>
        <h2 class="text-base font-semibold text-white mb-1">100 % sources ouvertes</h2>
        <p class="text-sm text-gray-400">API G√©o, DVF, ARCEP, Roulez-√âco.</p>
      </div>
    </section>

    <!-- ‚ïê‚ïê RECHERCHE CARBURANTS ‚ïê‚ïê -->
    <section class="mt-8 bg-card border border-border rounded-2xl p-6 fade-up">
      <div class="flex items-center gap-3 mb-5">
        <div class="w-9 h-9 rounded-xl bg-amber-500/15 flex items-center justify-center text-amber-400 shrink-0">
          <svg width="16" height="16" fill="none" stroke="currentColor" stroke-width="1.8" viewBox="0 0 24 24"><path d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13 5.4 5M7 13l-2 9h14l-2-9"/></svg>
        </div>
        <div>
          <h2 class="text-sm font-semibold text-white">Recherche prix carburants</h2>
          <p class="text-xs text-gray-500">Comparez les prix dans votre ville ‚Äî donn√©es officielles</p>
        </div>
      </div>

      <div class="flex flex-wrap gap-2">
        <div class="relative flex-1 min-w-[180px]">
          <input id="fuel-search-input" type="text" autocomplete="off" placeholder="Ville ou nom de station‚Ä¶"
            class="search-input w-full bg-surface border border-border rounded-xl pl-4 pr-4 py-2.5 text-sm text-white placeholder-gray-500 outline-none transition-all" />
        </div>
        <div class="relative">
          <select id="fuel-search-select"
            class="bg-surface border border-border rounded-xl pl-3 pr-8 py-2.5 text-sm text-gray-300 outline-none appearance-none cursor-pointer h-full">
            <option value="Tous">Tous carburants</option>
            <option value="SP95">SP95</option>
            <option value="SP98">SP98</option>
            <option value="Gazole">Gazole</option>
            <option value="E10">E10</option>
            <option value="E85">E85</option>
            <option value="GPLc">GPLc</option>
          </select>
          <span class="absolute right-2.5 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="m6 9 6 6 6-6"/></svg>
          </span>
        </div>
        <button id="fuel-search-btn"
          class="bg-amber-600 hover:bg-amber-500 text-white text-sm px-5 py-2.5 rounded-xl transition-colors font-medium whitespace-nowrap">
          Rechercher
        </button>
      </div>

      <div id="fuel-search-results"></div>
    </section>
  </template>

  <template id="tpl-apropos">
    <section class="max-w-3xl mx-auto fade-up">
      <h1 class="text-3xl font-bold text-white mb-4">√Ä propos de Vivre√Ä</h1>
      <p class="text-gray-400 leading-relaxed mb-4"><strong class="text-white">Vivre√Ä</strong> est une plateforme open data d√©di√©e aux 35 000 communes fran√ßaises.</p>
      <h2 class="text-xl font-semibold text-white mt-8 mb-3">Sources</h2>
      <ul class="space-y-2 text-sm text-gray-400">
        <li><strong class="text-gray-200">Communes :</strong> <a href="https://geo.api.gouv.fr" class="text-indigo-400 hover:underline" target="_blank">geo.api.gouv.fr</a></li>
        <li><strong class="text-gray-200">Immobilier DVF :</strong> <a href="https://apidf-preprod.cerema.fr" class="text-indigo-400 hover:underline" target="_blank">apidf-preprod.cerema.fr</a></li>
        <li><strong class="text-gray-200">Fibre ARCEP :</strong> <a href="https://data.arcep.fr" class="text-indigo-400 hover:underline" target="_blank">data.arcep.fr</a></li>
        <li><strong class="text-gray-200">Carburants :</strong> <a href="https://donnees.roulez-eco.fr" class="text-indigo-400 hover:underline" target="_blank">donnees.roulez-eco.fr</a></li>
      </ul>
    </section>
  </template>

  <template id="tpl-mentions">
    <section class="max-w-3xl mx-auto fade-up">
      <h1 class="text-3xl font-bold text-white mb-4">Mentions l√©gales</h1>
      <p class="text-gray-400 leading-relaxed mb-4">Site √©dit√© par Vox Novalys. Cookies publicitaires via Google AdSense (pub-2156803616781959).</p>
      <p class="text-gray-400 leading-relaxed">Partenaire Amazon ‚Äî tag : <strong class="text-gray-200">vivrea-21</strong>.</p>
    </section>
  </template>

  <!-- ‚ïê‚ïê SCRIPT ‚ïê‚ïê -->
  <script>
  'use strict';

  const BASE_URL  = 'https://vivrea.vox-novalys.fr';
  const DATA_BASE = '/data';
  const AMZN_TAG  = 'vivrea-21';

  // ‚îÄ‚îÄ √âtat global ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const state = {
    workerReady:    false,
    currentCommune: null,   // commune actuellement affich√©e
  };
  const depCache = {};      // cache des fichiers details/{dep}.json

  // Mode comparaison : true quand le bouton "Comparer" a √©t√© cliqu√©
  let isComparing = false;

  // ‚îÄ‚îÄ Web Worker (recherche hors-thread) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let worker = null;
  const workerCbs = {};   // { channelId ‚Üí resolveFn }

  // Code inline du worker (fallback si search.worker.js non accessible)
  const WORKER_SRC = `
    'use strict';
    let idx=[],norm=[];
    const norm_=s=>String(s).toLowerCase().normalize('NFD').replace(/[\\u0300-\\u036f]/g,'').trim();
    function score(n,q){if(n===q)return 100;if(n.startsWith(q))return 80;if(n.split(/[-\\s]+/).some(w=>w.startsWith(q)))return 60;if(n.includes(q))return 40;return 0;}
    self.onmessage=({data:{type,payload}})=>{
      if(type==='INIT'){
        idx=payload;
        norm=idx.map(c=>norm_(c[0]));
        self.postMessage({type:'READY',payload:{size:idx.length}});
        return;
      }
      if(type==='SEARCH'){
        const{query,limit=8,ch='S'}=payload;
        const q=norm_(query);
        if(!q){self.postMessage({type:'RESULTS',payload:{results:[],ch}});return;}
        const res=[];
        for(let i=0;i<norm.length;i++){
          const n=norm[i];
          const cp=String(idx[i][2]||'');
          const code=String(idx[i][1]);
          const s=score(n,q);
          const codeMatch=code===q;
          if(s>0||(cp.startsWith(q)&&q.length>=2)||codeMatch){
            res.push({
              nom:        String(idx[i][0]),
              code_insee: code,  // TOUJOURS String
              cp:         String(idx[i][2]||''),
              pop:        idx[i][3]||0,
              _s: s||(codeMatch?90:0)||(cp.startsWith(q)?20:0)
            });
          }
        }
        res.sort((a,b)=>b._s-a._s||b.pop-a.pop);
        self.postMessage({type:'RESULTS',payload:{results:res.slice(0,limit).map(({_s,...r})=>r),ch}});
      }
    };
  `;

  function initWorker() {
    function attachHandlers() {
      worker.onmessage = ({ data: { type, payload } }) => {
        if (type === 'READY') {
          state.workerReady = true;
          const el = document.getElementById('worker-status');
          if (el) {
            el.innerHTML = `<span class="w-1.5 h-1.5 rounded-full bg-emerald-400 inline-block"></span> ${payload.size.toLocaleString('fr')} communes`;
            el.classList.remove('hidden');
          }
          const sc = document.getElementById('stat-communes');
          if (sc) sc.textContent = payload.size.toLocaleString('fr');
        }
        if (type === 'RESULTS') {
          const cb = workerCbs[payload.ch];
          if (cb) { delete workerCbs[payload.ch]; cb(payload.results); }
        }
      };
    }

    try {
      // Chemin absolu : fonctionne quelle que soit l'URL SPA courante (/ville/xxx, etc.)
      worker = new Worker('/search.worker.js');
      attachHandlers();
      worker.onerror = () => {
        console.warn('[Worker] /search.worker.js inaccessible ‚Äì bascule vers le worker inline');
        worker = new Worker(URL.createObjectURL(new Blob([WORKER_SRC], { type: 'application/javascript' })));
        attachHandlers();
        loadIndex(); // Re-envoyer INIT au nouveau worker
      };
    } catch (_) {
      worker = new Worker(URL.createObjectURL(new Blob([WORKER_SRC], { type: 'application/javascript' })));
      attachHandlers();
    }
  }

  // Identifiant unique par requ√™te ‚Üí √©vite les collisions de channel
  let _seq = 0;
  function wSearch(query, limit, prefix) {
    if (!worker) return Promise.resolve([]);
    const ch = (prefix || 'S') + '_' + (++_seq);
    return new Promise(resolve => {
      // Timeout de s√©curit√© : si le worker ne r√©pond pas en 5s, r√©soudre avec []
      const t = setTimeout(() => {
        delete workerCbs[ch];
        console.warn('[Vivre√Ä] wSearch timeout pour :', query);
        resolve([]);
      }, 5000);
      workerCbs[ch] = results => { clearTimeout(t); resolve(results); };
      worker.postMessage({ type: 'SEARCH', payload: { query, limit: limit || 8, ch } });
    });
  }

  async function loadIndex() {
    try {
      const r = await fetch(`${DATA_BASE}/index.json`, { cache: 'default' });
      if (!r.ok) throw new Error(`HTTP ${r.status}`);
      worker.postMessage({ type: 'INIT', payload: await r.json() });
    } catch (e) {
      console.warn('[Vivre√Ä] Index non disponible :', e.message);
      const el = document.getElementById('worker-status');
      if (el) el.textContent = 'Index indisponible';
    }
  }

  // ‚îÄ‚îÄ Router ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function getRoute(path) {
    const p = path.replace(/\/$/, '') || '/';
    if (p === '/' || p === '')      return { view: 'home' };
    if (p.startsWith('/ville/'))    return { view: 'ville',   slug: p.slice(7) };
    if (p.startsWith('/comparer/')) return { view: 'compare', codes: p.slice(10).split('/').filter(Boolean) };
    if (p === '/a-propos')          return { view: 'apropos' };
    if (p === '/mentions-legales')  return { view: 'mentions' };
    return { view: '404' };
  }

  function navigate(path, evt) {
    if (evt) evt.preventDefault();
    history.pushState(null, '', path);
    route(path);
  }

  function route(path) {
    isComparing = false;
    const app = document.getElementById('app');
    app.innerHTML = '';
    window.scrollTo({ top: 0, behavior: 'instant' });
    const r = getRoute(path);
    if (r.view === 'home')    return renderHome(app);
    if (r.view === 'ville')   return renderVille(app, r.slug);
    if (r.view === 'compare') return renderComparePage(app, r.codes);
    if (r.view === 'apropos') return renderStatic(app, 'tpl-apropos', 'Vivre√Ä ‚Äì √Ä propos');
    if (r.view === 'mentions') return renderStatic(app, 'tpl-mentions', 'Vivre√Ä ‚Äì Mentions l√©gales');
    return render404(app);
  }

  window.addEventListener('popstate', () => route(location.pathname));

  // ‚îÄ‚îÄ Accueil ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderHome(container) {
    setSEO('Vivre√Ä ‚Äì D√©couvrez votre prochaine commune', 'Base de donn√©es exhaustive des 35 000 communes fran√ßaises.', BASE_URL + '/');
    container.appendChild(document.getElementById('tpl-home').content.cloneNode(true));
    try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(_) {}
    initMainSearch();
    if (typeof FuelSearch !== 'undefined') {
      FuelSearch.init('fuel-search-input', 'fuel-search-select', 'fuel-search-btn', 'fuel-search-results');
    }
  }

  // ‚îÄ‚îÄ Omnisearch ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  let _mainDebounce = null;
  let _ddIdx = -1;

  function initMainSearch() {
    const input    = document.getElementById('search-input');
    const dropdown = document.getElementById('search-dropdown');
    const loader   = document.getElementById('search-loader');
    if (!input) return;

    input.addEventListener('input', () => {
      const q = input.value.trim();
      clearTimeout(_mainDebounce);

      if (!q) {
        loader?.classList.add('hidden');
        hideDD(dropdown);
        return;
      }

      loader?.classList.remove('hidden');

      _mainDebounce = setTimeout(async () => {
        if (!state.workerReady) {
          loader?.classList.add('hidden');
          dropdown.innerHTML = `<li class="px-4 py-3 text-sm text-gray-500 text-center">Chargement des donn√©es en cours‚Ä¶</li>`;
          dropdown.classList.remove('hidden');
          return;
        }
        try {
          console.log('[Vivre√Ä] Recherche :', q);
          const results = await wSearch(q, 8, 'MAIN');
          if (!results) { loader?.classList.add('hidden'); return; }
          console.log('[Vivre√Ä] ‚Üí', results.length, 'r√©sultats, premier code_insee =', results[0]?.code_insee, '(type:', typeof results[0]?.code_insee, ')');
          renderDD(dropdown, results, input, r => navigate('/ville/' + r.code_insee));
        } catch (e) {
          console.error('[Vivre√Ä] Erreur recherche :', e);
        } finally {
          loader?.classList.add('hidden');
        }
      }, 120);
    });

    input.addEventListener('keydown', e => {
      const items = dropdown.querySelectorAll('.suggestion-item');
      if (e.key === 'ArrowDown') { e.preventDefault(); _ddIdx = Math.min(_ddIdx + 1, items.length - 1); markActive(items); }
      if (e.key === 'ArrowUp')   { e.preventDefault(); _ddIdx = Math.max(_ddIdx - 1, 0); markActive(items); }
      if (e.key === 'Enter')     { (_ddIdx >= 0 ? items[_ddIdx] : items[0])?.click(); }
      if (e.key === 'Escape')    hideDD(dropdown);
    });

    document.addEventListener('click', e => {
      if (!e.target.closest('#search-container')) hideDD(dropdown);
    });
  }

  function renderDD(dropdown, results, input, onSelect) {
    dropdown.innerHTML = '';
    _ddIdx = -1;
    if (!results.length) {
      dropdown.innerHTML = `<li class="px-4 py-3 text-sm text-gray-500">Aucun r√©sultat pour ¬´ <em>${esc(input.value)}</em> ¬ª</li>`;
      dropdown.classList.remove('hidden');
      return;
    }
    results.forEach((r, i) => {
      const li = document.createElement('li');
      li.className = 'suggestion-item flex items-center justify-between px-4 py-2.5 cursor-pointer border-b border-border last:border-0 transition-colors';
      li.innerHTML = `
        <div class="flex items-center gap-3 min-w-0">
          <span class="text-gray-600 text-xs w-3 shrink-0">${i + 1}</span>
          <div class="min-w-0">
            <span class="text-sm font-medium text-white">${highlight(r.nom, input.value)}</span>
            <span class="text-xs text-gray-500 ml-1">(${r.cp || '‚Äî'})</span>
          </div>
        </div>
        <div class="flex items-center gap-2 shrink-0 ml-3">
          ${r.pop ? `<span class="badge bg-surface text-gray-400">${fmtPop(r.pop)}</span>` : ''}
          <span class="badge bg-indigo-500/20 text-indigo-300">${r.code_insee}</span>
        </div>`;
      li.addEventListener('click', () => { input.value = r.nom; hideDD(dropdown); onSelect(r); });
      dropdown.appendChild(li);
    });
    dropdown.classList.remove('hidden');
  }

  function markActive(items) {
    items.forEach((el, i) => el.classList.toggle('active', i === _ddIdx));
    items[_ddIdx]?.scrollIntoView({ block: 'nearest' });
  }
  function hideDD(el) { if (el) { el.classList.add('hidden'); el.innerHTML = ''; } _ddIdx = -1; }

  // ‚îÄ‚îÄ Fiche Ville ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function renderVille(container, slug) {
    // Structure fixe : deux colonnes, city-details-2 cach√©e tant que compare inactif
    container.innerHTML = `
      <div id="compare-grid" class="grid grid-cols-1 gap-6">
        <div id="city-details-1" class="min-w-0">
          <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
            ${Array(8).fill('<div class="skeleton h-24 rounded-2xl"></div>').join('')}
          </div>
        </div>
        <div id="city-details-2" class="min-w-0 hidden"></div>
      </div>`;

    const col1 = document.getElementById('city-details-1');

    try {
      const commune = /^\d{5}$/.test(slug)
        ? await fetchByInsee(slug)
        : await fetchBySlug(slug);

      if (!commune) {
        col1.innerHTML = `
          <div class="text-center py-16 fade-up">
            <p class="text-4xl font-black text-gray-800 mb-3">üîç</p>
            <p class="text-lg font-semibold text-white mb-2">Ville non trouv√©e</p>
            <p class="text-sm text-gray-500 mb-6">Aucune commune ne correspond √† <code class="text-indigo-400">${esc(slug)}</code>.</p>
            <button onclick="navigate('/',event)" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-5 py-2 rounded-xl transition-colors">‚Üê Retour √† la recherche</button>
          </div>`;
        return;
      }

      state.currentCommune = commune;
      setSEO(
        `${commune.nom} (${commune.cp || commune.code_dep}) ‚Äì Vivre√Ä`,
        `${commune.nom} : immobilier, fibre, carburants.`,
        `${BASE_URL}/ville/${commune.code_insee}`,
      );

      // Fallback DVF : si le JSON local ne contient pas les donn√©es immo,
      // tenter un appel direct √† l'API CEREMA (open data, CORS autoris√©)
      if (!commune.immo && commune.code_insee) {
        try {
          const annee = new Date().getFullYear() - 1;
          const dvf = await fetchJSON(
            `https://apidf-preprod.cerema.fr/indicateurs/dv3f/communes?code_commune=${commune.code_insee}&annee=${annee}`
          );
          const r = dvf?.results?.[0];
          if (r?.prix_m2_median) {
            commune.immo = {
              prix_m2_median:  r.prix_m2_median,
              loyer_median:    r.loyer_median    ?? null,
              nb_transactions: r.nb_ventes       ?? null,
              annee_dvf:       annee,
            };
          }
        } catch (_) { /* silencieux */ }
      }

      col1.innerHTML = buildVilleHTML(commune);
      col1.classList.add('fade-up');
      try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(_) {}
      loadFuelIntoEl('fuel-main', commune);

    } catch (err) {
      col1.innerHTML = `<p class="text-center text-red-400 py-12">Erreur : ${esc(err.message)}</p>`;
    }
  }

  function buildVilleHTML(c) {
    const dens    = c.surface_km2 && c.population ? Math.round(c.population / c.surface_km2) : null;
    const fibreOk = c.fibre_pct != null;
    const fc  = !fibreOk ? 'text-gray-500'  : c.fibre_pct >= 80 ? 'text-emerald-400' : c.fibre_pct >= 40 ? 'text-amber-400' : 'text-rose-400';
    const fb  = !fibreOk ? 'bg-card'        : c.fibre_pct >= 80 ? 'bg-emerald-500/10' : c.fibre_pct >= 40 ? 'bg-amber-500/10' : 'bg-rose-500/10';
    const fbc = !fibreOk ? 'bg-gray-700'    : c.fibre_pct >= 80 ? 'bg-emerald-400'    : c.fibre_pct >= 40 ? 'bg-amber-400'    : 'bg-rose-400';

    return `
    <div class="mb-6">
      <div class="flex items-start justify-between gap-4 flex-wrap">
        <div>
          <h1 class="text-3xl sm:text-4xl font-bold text-white">${esc(c.nom)}</h1>
          <p class="text-gray-400 mt-1 text-sm">
            D√©p.&nbsp;<strong class="text-gray-300">${esc(c.code_dep)}</strong>&nbsp;¬∑
            INSEE&nbsp;<code class="text-indigo-300">${esc(c.code_insee)}</code>
            ${c.cp ? `&nbsp;¬∑&nbsp;CP&nbsp;<code class="text-indigo-300">${esc(c.cp)}</code>` : ''}
          </p>
        </div>
        <div class="flex gap-2 flex-wrap">
          <button id="btn-copy-insee" onclick="copyInsee('${esc(c.code_insee)}')"
            class="text-xs border border-border rounded-lg px-3 py-1.5 text-gray-400 hover:text-white hover:border-indigo-500 transition-colors">
            Copier INSEE
          </button>
          ${c.lat && c.lon ? `<a href="https://www.google.com/maps?q=${c.lat},${c.lon}" target="_blank" rel="noopener"
             class="text-xs border border-border rounded-lg px-3 py-1.5 text-gray-400 hover:text-white hover:border-indigo-500 transition-colors">Carte ‚Üó</a>` : ''}
          <button onclick="toggleComparisonMode('${esc(c.code_insee)}','${esc(c.nom)}')"
            class="text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded-lg px-3 py-1.5 transition-colors font-medium flex items-center gap-1.5">
            <svg width="11" height="11" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><rect x="3" y="3" width="7" height="18" rx="1"/><rect x="14" y="3" width="7" height="18" rx="1"/></svg>
            Comparer
          </button>
        </div>
      </div>
    </div>

    <div class="grid grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
      <div class="bento-card bg-card border border-border rounded-2xl p-5">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Population</p>
        <p class="text-2xl font-bold text-white">${c.population ? c.population.toLocaleString('fr') : '‚Äî'}</p>
        ${dens ? `<p class="text-xs text-gray-500 mt-1">${dens.toLocaleString('fr')} hab/km¬≤</p>` : ''}
      </div>
      <div class="bento-card bg-card border border-border rounded-2xl p-5">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Superficie</p>
        <p class="text-2xl font-bold text-white">${c.surface_km2 ? c.surface_km2.toLocaleString('fr') : '‚Äî'}</p>
        <p class="text-xs text-gray-500 mt-1">km¬≤</p>
      </div>
      <div class="bento-card ${fb} border border-border rounded-2xl p-5">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Fibre FTTH</p>
        <p class="text-2xl font-bold ${fc}">${fibreOk ? c.fibre_pct + ' %' : '‚Äî'}</p>
        <p class="text-xs text-gray-500 mt-1">${fibreOk ? 'locaux raccordables' : 'donn√©es ARCEP non disponibles'}</p>
        ${fibreOk ? `<div class="mt-2 bg-black/20 rounded-full h-1.5"><div class="bar-fill h-1.5 rounded-full ${fbc}" style="width:${c.fibre_pct}%"></div></div>` : ''}
      </div>
      <div class="bento-card bg-card border border-border rounded-2xl p-5">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Code postal</p>
        <p class="text-2xl font-bold text-white">${c.cp || '‚Äî'}</p>
        ${c.codes_postaux?.length > 1 ? `<p class="text-xs text-gray-500 mt-1">+${c.codes_postaux.length - 1} autre(s)</p>` : ''}
      </div>
    </div>

    <div class="bento-card bg-card border border-border rounded-2xl p-5 mb-4">
      <div class="flex items-center justify-between mb-4">
        <h2 class="text-sm font-semibold text-white">Immobilier (DVF)</h2>
        <span class="badge bg-indigo-500/20 text-indigo-300">${c.immo?.annee_dvf || 'DVF'}</span>
      </div>
      ${c.immo ? `
      <div class="grid grid-cols-2 sm:grid-cols-3 gap-4">
        ${c.immo.prix_m2_median ? `<div><p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Prix m√©dian m¬≤</p><p class="text-xl font-bold text-white">${Math.round(c.immo.prix_m2_median).toLocaleString('fr')} ‚Ç¨</p></div>` : ''}
        ${c.immo.loyer_median   ? `<div><p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Loyer m√©dian m¬≤</p><p class="text-xl font-bold text-white">${c.immo.loyer_median.toFixed(1)} ‚Ç¨</p></div>` : ''}
        ${c.immo.nb_transactions? `<div><p class="text-xs text-gray-500 uppercase tracking-wider mb-1">Transactions</p><p class="text-xl font-bold text-white">${c.immo.nb_transactions.toLocaleString('fr')}</p></div>` : ''}
      </div>` : `
      <p class="text-sm text-gray-500">Aucune transaction DVF enregistr√©e pour cette commune.<br>
        <span class="text-xs text-gray-600">Les petites communes peuvent ne pas figurer dans la base DVF si le volume de ventes est insuffisant.</span>
      </p>`}
    </div>

    <div class="bento-card bg-card border border-border rounded-2xl p-5 mb-4">
      <h2 class="text-sm font-semibold text-white mb-3">Carburants √† proximit√©</h2>
      <div id="fuel-main"><div class="skeleton h-16 rounded-xl"></div></div>
    </div>

    <div class="my-6 flex justify-center overflow-hidden">
      <ins class="adsbygoogle" style="display:block;width:100%;max-width:728px;height:90px"
           data-ad-client="ca-pub-2156803616781959" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
    </div>

    ${buildAmazonBlock(c)}

    <button onclick="navigate('/',event)" class="text-sm text-gray-500 hover:text-indigo-400 transition-colors mt-4 block">‚Üê Retour √† la recherche</button>
    `;
  }

  // ‚îÄ‚îÄ Mode Comparaison ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  /**
   * toggleComparisonMode(codeA, nomA)
   *
   * Appel√© par le bouton "Comparer" sur la fiche ville.
   * - Met isComparing = true
   * - Affiche city-details-2 (vide) √† droite de city-details-1
   * - Initialise une barre de recherche dans city-details-2
   *
   * Aucune navigation, aucun rechargement de la ville A.
   */
  function toggleComparisonMode(codeA, nomA) {
    if (isComparing) return;   // d√©j√† actif
    isComparing = true;
    console.log('[Vivre√Ä] toggleComparisonMode ‚Üí codeA =', codeA, '(type:', typeof codeA, ')');

    history.pushState(null, '', '/comparer/' + codeA);

    // Passer √† la grille 2 colonnes et ajouter la s√©paration visuelle
    const grid = document.getElementById('compare-grid');
    if (grid) grid.classList.add('lg:grid-cols-2');
    const col1 = document.getElementById('city-details-1');
    if (col1) col1.classList.add('in-compare');

    // Afficher et remplir la colonne B
    const col2 = document.getElementById('city-details-2');
    if (!col2) { console.error('[Vivre√Ä] city-details-2 introuvable'); return; }

    col2.classList.remove('hidden');
    col2.innerHTML = `
      <div class="flex items-center gap-2 mb-4 pb-2 border-b border-purple-500/30">
        <div class="w-2 h-2 rounded-full bg-purple-500 shrink-0"></div>
        <h2 class="text-sm font-bold text-purple-400 truncate" id="cmp-col-title">Choisir une ville</h2>
        <button onclick="closeComparisonMode('${esc(codeA)}')"
          class="ml-auto text-gray-600 hover:text-white transition-colors leading-none shrink-0"
          title="Fermer la comparaison">‚úï</button>
      </div>

      <div id="cmp-search-wrap" class="relative mb-3">
        <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 pointer-events-none">
          <svg width="13" height="13" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        </span>
        <input id="cmp-input" type="search" autocomplete="off" spellcheck="false"
          class="search-input w-full bg-card border border-border rounded-xl pl-9 pr-4 py-2.5 text-sm text-white placeholder-gray-500 outline-none transition-all"
          placeholder="Chercher une ville √† comparer‚Ä¶" />
      </div>
      <ul id="cmp-dropdown" class="hidden mb-3 bg-card border border-border rounded-xl overflow-hidden shadow-2xl max-h-52 overflow-y-auto"></ul>

      <div id="city-details-2-content" class="text-center py-10 text-gray-600 text-sm">
        <svg class="mx-auto mb-3 opacity-30" width="32" height="32" fill="none" stroke="currentColor" stroke-width="1.5" viewBox="0 0 24 24"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
        Tapez le nom d'une commune pour comparer
      </div>`;

    initCmpSearch(codeA);
    setTimeout(() => document.getElementById('cmp-input')?.focus(), 80);
  }

  function closeComparisonMode(codeA) {
    isComparing = false;
    history.pushState(null, '', '/ville/' + codeA);

    const grid = document.getElementById('compare-grid');
    if (grid) grid.classList.remove('lg:grid-cols-2');
    const col1 = document.getElementById('city-details-1');
    if (col1) col1.classList.remove('in-compare');
    const col2 = document.getElementById('city-details-2');
    if (col2) { col2.classList.add('hidden'); col2.innerHTML = ''; }
  }

  function initCmpSearch(codeA) {
    const input    = document.getElementById('cmp-input');
    const dropdown = document.getElementById('cmp-dropdown');
    if (!input) return;

    let timer = null;

    input.oninput = () => {
      const q = input.value.trim();
      clearTimeout(timer);
      if (!q) { hideDD(dropdown); return; }

      timer = setTimeout(async () => {
        if (!state.workerReady) return;
        try {
          const results = await wSearch(q, 7, 'CMP');
          renderDD(dropdown, results, input, async r => {
            input.value = r.nom;
            hideDD(dropdown);

            const title = document.getElementById('cmp-col-title');
            if (title) title.textContent = r.nom;
            history.pushState(null, '', '/comparer/' + codeA + '/' + r.code_insee);

            // Masquer la barre de recherche
            const wrap = document.getElementById('cmp-search-wrap');
            if (wrap) wrap.classList.add('hidden');

            // Charger la ville B
            const content = document.getElementById('city-details-2-content');
            if (content) {
              content.innerHTML = `<div class="skeleton h-28 rounded-xl mb-2"></div><div class="skeleton h-28 rounded-xl"></div>`;
              console.log('[Vivre√Ä] Chargement ville B ‚Äì code_insee =', r.code_insee, '(type:', typeof r.code_insee, ')');
              const communeB = await fetchByInsee(r.code_insee);
              if (!communeB) {
                content.innerHTML = `<p class="text-sm text-gray-500 text-center py-6">Commune introuvable (${esc(r.code_insee)}).</p>`;
              } else {
                content.innerHTML = buildCompactHTML(communeB);
                loadFuelIntoEl('fuel-cmp', communeB);
              }
            }

            // Bouton "Changer de ville"
            if (wrap) {
              const changeBtn = document.createElement('button');
              changeBtn.className = 'text-xs text-gray-500 hover:text-indigo-400 transition-colors mb-3 block';
              changeBtn.textContent = '‚Ü∫ Changer de ville';
              changeBtn.onclick = () => {
                wrap.classList.remove('hidden');
                input.value = '';
                input.focus();
                changeBtn.remove();
              };
              wrap.after(changeBtn);
            }
          });
        } catch (e) {
          console.error('[Vivre√Ä] Erreur recherche comparaison :', e);
        }
      }, 150);
    };

    input.onkeydown = e => { if (e.key === 'Escape') closeComparisonMode(codeA); };

    document.addEventListener('click', e => {
      if (!e.target.closest('#cmp-input') && !e.target.closest('#cmp-dropdown')) hideDD(dropdown);
    });
  }

  // HTML compact pour la colonne de comparaison
  function buildCompactHTML(c) {
    const fibreOk = c.fibre_pct != null;
    const fc  = !fibreOk ? 'text-gray-500' : c.fibre_pct >= 80 ? 'text-emerald-400' : c.fibre_pct >= 40 ? 'text-amber-400' : 'text-rose-400';
    const fbc = !fibreOk ? 'bg-gray-700'   : c.fibre_pct >= 80 ? 'bg-emerald-400'   : c.fibre_pct >= 40 ? 'bg-amber-400'   : 'bg-rose-400';
    const dens = c.surface_km2 && c.population ? Math.round(c.population / c.surface_km2) : null;

    return `
    <div class="space-y-3 fade-up">
      <div class="grid grid-cols-2 gap-2">
        <div class="bg-card border border-border rounded-xl p-3">
          <p class="text-xs text-gray-500 mb-0.5">Population</p>
          <p class="text-base font-bold text-white">${c.population ? c.population.toLocaleString('fr') : '‚Äî'}</p>
          ${dens ? `<p class="text-xs text-gray-500">${dens.toLocaleString('fr')} hab/km¬≤</p>` : ''}
        </div>
        <div class="bg-card border border-border rounded-xl p-3">
          <p class="text-xs text-gray-500 mb-0.5">Superficie</p>
          <p class="text-base font-bold text-white">${c.surface_km2 ? c.surface_km2.toLocaleString('fr') + ' km¬≤' : '‚Äî'}</p>
        </div>
        <div class="bg-card border border-border rounded-xl p-3">
          <p class="text-xs text-gray-500 mb-0.5">Fibre FTTH</p>
          <p class="text-base font-bold ${fc}">${fibreOk ? c.fibre_pct + ' %' : '‚Äî'}</p>
          ${fibreOk ? `<div class="mt-1 bg-black/20 rounded-full h-1"><div class="bar-fill h-1 rounded-full ${fbc}" style="width:${c.fibre_pct}%"></div></div>` : ''}
        </div>
        <div class="bg-card border border-border rounded-xl p-3">
          <p class="text-xs text-gray-500 mb-0.5">Code postal</p>
          <p class="text-base font-bold text-white">${c.cp || '‚Äî'}</p>
        </div>
      </div>
      ${c.immo ? `
      <div class="bg-card border border-border rounded-xl p-3">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Immobilier ${c.immo.annee_dvf || ''}</p>
        <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-sm">
          ${c.immo.prix_m2_median ? `<div><span class="text-xs text-gray-500">Prix m¬≤</span><br/><strong class="text-white">${Math.round(c.immo.prix_m2_median).toLocaleString('fr')} ‚Ç¨</strong></div>` : ''}
          ${c.immo.loyer_median   ? `<div><span class="text-xs text-gray-500">Loyer m¬≤</span><br/><strong class="text-white">${c.immo.loyer_median.toFixed(1)} ‚Ç¨</strong></div>` : ''}
        </div>
      </div>` : ''}
      <div class="bg-card border border-border rounded-xl p-3">
        <p class="text-xs text-gray-500 uppercase tracking-wider mb-2">Carburants</p>
        <div id="fuel-cmp"><div class="skeleton h-6 rounded-lg"></div></div>
      </div>
      <a href="/ville/${c.code_insee}" onclick="navigate('/ville/${c.code_insee}',event)"
         class="inline-block text-xs text-gray-500 hover:text-purple-400 transition-colors">
        Fiche compl√®te de ${esc(c.nom)} ‚Üí
      </a>
    </div>`;
  }

  // ‚îÄ‚îÄ Comparaison depuis URL directe /comparer/A[/B] ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function renderComparePage(container, codes) {
    const [codeA, codeB] = codes;

    if (!codeB) {
      // Un seul code ‚Üí charger la ville A puis activer le mode comparaison
      await renderVille(container, codeA);
      setTimeout(() => {
        if (state.currentCommune) toggleComparisonMode(codeA, state.currentCommune.nom);
      }, 200);
      return;
    }

    // Deux codes ‚Üí comparaison directe (URL partageable)
    const wrap = document.createElement('div');
    wrap.className = 'fade-up';
    container.appendChild(wrap);
    wrap.innerHTML = `<div class="grid grid-cols-2 sm:grid-cols-4 gap-3">${Array(8).fill('<div class="skeleton h-24 rounded-xl"></div>').join('')}</div>`;

    const [a, b] = await Promise.all([fetchByInsee(codeA), fetchByInsee(codeB)]);
    if (!a || !b) { wrap.innerHTML = `<p class="text-center text-gray-500 py-12">Communes introuvables.</p>`; return; }

    setSEO(
      `${a.nom} vs ${b.nom} ‚Äì Comparaison Vivre√Ä`,
      `Comparez ${a.nom} et ${b.nom} : immobilier, fibre, carburants.`,
      `${BASE_URL}/comparer/${codeA}/${codeB}`,
    );

    wrap.innerHTML = `
      <div class="mb-4 flex items-center gap-3 text-xs text-gray-500">
        <button onclick="navigate('/',event)" class="hover:text-white transition-colors">‚Üê Accueil</button>
        <span class="text-gray-700">|</span>
        <span>${esc(a.nom)} <span class="text-indigo-400">vs</span> ${esc(b.nom)}</span>
      </div>
      <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
        <div class="min-w-0" style="border-right:1px solid #2a2a2a;padding-right:1.5rem">
          <div class="flex items-center gap-2 mb-4 pb-2 border-b border-indigo-500/30">
            <div class="w-2 h-2 rounded-full bg-indigo-500 shrink-0"></div>
            <h2 class="text-sm font-bold text-indigo-400 truncate">${esc(a.nom)}</h2>
            <a href="/ville/${codeA}" onclick="navigate('/ville/${codeA}',event)" class="ml-auto text-xs text-gray-600 hover:text-indigo-400 transition-colors shrink-0">Vue compl√®te ‚Üó</a>
          </div>
          ${buildCompactHTML(a)}
        </div>
        <div class="min-w-0">
          <div class="flex items-center gap-2 mb-4 pb-2 border-b border-purple-500/30">
            <div class="w-2 h-2 rounded-full bg-purple-500 shrink-0"></div>
            <h2 class="text-sm font-bold text-purple-400 truncate">${esc(b.nom)}</h2>
            <a href="/ville/${codeB}" onclick="navigate('/ville/${codeB}',event)" class="ml-auto text-xs text-gray-600 hover:text-purple-400 transition-colors shrink-0">Vue compl√®te ‚Üó</a>
          </div>
          ${buildCompactHTML(b)}
        </div>
      </div>
      <div class="my-6 flex justify-center overflow-hidden">
        <ins class="adsbygoogle" style="display:block;width:100%;max-width:728px;height:90px"
             data-ad-client="ca-pub-2156803616781959" data-ad-slot="auto" data-ad-format="auto" data-full-width-responsive="true"></ins>
      </div>
      ${buildAmazonBlock(null, 'compare')}`;

    try { (adsbygoogle = window.adsbygoogle || []).push({}); } catch(_) {}
    // Dans ce mode les IDs fuel-cmp sont partag√©s ‚Üí on les rend distincts
    loadFuelIntoEl('fuel-cmp', a);
    loadFuelIntoEl('fuel-cmp', b);
  }

  // ‚îÄ‚îÄ Carburants ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

  /**
   * Formate un prix carburant en euros avec 3 d√©cimales.
   *
   * Le JSON stocke d√©sormais des euros d√©cimaux normalis√©s (ex: 1.732).
   * Aucune division n√©cessaire ici.
   * Garde-fou : si jamais une ancienne valeur > 100 est pr√©sente, on divise.
   */
  function fmtFuelPrice(raw) {
    if (raw == null || raw === 0) return '‚Äî';
    const price = raw > 100 ? raw / 1000 : raw;
    return price.toFixed(3) + ' ‚Ç¨';
  }

  // Distance orthodromique en kilom√®tres (formule de Haversine)
  function haversine(lat1, lon1, lat2, lon2) {
    const R = 6371, d2r = Math.PI / 180;
    const dLat = (lat2 - lat1) * d2r, dLon = (lon2 - lon1) * d2r;
    const a = Math.sin(dLat/2)**2 + Math.cos(lat1*d2r) * Math.cos(lat2*d2r) * Math.sin(dLon/2)**2;
    return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
  }

  async function loadFuelIntoEl(elId, commune) {
    const el = document.getElementById(elId);
    if (!el) return;
    try {
      const data = await fetchJSON(`${DATA_BASE}/carburants.json`);
      if (!data?.stations?.length) throw new Error('vide');

      const RADIUS_KM = 10;
      const cLat = commune.lat, cLon = commune.lon;
      const hasGeo = cLat != null && cLon != null;

      let stations;
      if (hasGeo) {
        // Filtre g√©ographique : rayon 10 km, tri√© par distance croissante
        stations = data.stations
          .map(s => ({ ...s, _dist: (s.lat != null && s.lon != null) ? haversine(cLat, cLon, s.lat, s.lon) : Infinity }))
          .filter(s => s._dist <= RADIUS_KM)
          .sort((a, b) => a._dist - b._dist);
      } else {
        // Fallback CP/d√©partement si pas de coordonn√©es sur la commune
        const cp  = String(commune.cp || '');
        const dep = String(commune.code_dep || '').padStart(2, '0');
        let matched = data.stations.filter(s => String(s.cp) === cp);
        if (!matched.length && dep) matched = data.stations.filter(s => String(s.cp || '').startsWith(dep));
        stations = matched.map(s => ({ ...s, _dist: null }));
      }

      if (!stations.length) {
        el.innerHTML = `<p class="text-xs text-gray-500">Aucune station dans un rayon de ${RADIUS_KM} km.</p>`;
        return;
      }

      const totalCount = stations.length;

      if (elId === 'fuel-main') {
        const TYPES = ['SP95', 'SP98', 'Gazole', 'E10', 'E85', 'GPLc'];
        const ts  = new Date(data.updated_at).toLocaleString('fr');
        const MAX = 25;
        const shown = stations.slice(0, MAX);

        const titleEl = el.closest('.bento-card')?.querySelector('h2');
        if (titleEl) titleEl.textContent = hasGeo
          ? `Stations dans un rayon de ${RADIUS_KM} km`
          : 'Carburants dans la ville';

        el.innerHTML = `
          <p class="text-xs text-gray-500 mb-3">
            M√†j : ${ts} ¬∑
            <strong class="text-gray-400">${totalCount}</strong> station${totalCount > 1 ? 's' : ''}
            ${totalCount > MAX ? ` ¬∑ <em>${MAX} affich√©es</em>` : ''}
            ${hasGeo ? ' ¬∑ par distance' : ''}
          </p>
          <div class="overflow-x-auto -mx-1">
            <table class="w-full text-xs min-w-max">
              <thead>
                <tr class="text-gray-500 text-left border-b border-border">
                  <th class="pb-2 pr-4 font-medium">Station</th>
                  ${hasGeo ? '<th class="pb-2 pr-3 font-medium text-right">Dist.</th>' : ''}
                  ${TYPES.map(t => `<th class="pb-2 pr-3 font-medium">${t}</th>`).join('')}
                </tr>
              </thead>
              <tbody>
                ${shown.map(s => {
                  const name = s.nom || s.adresse || '‚Äî';
                  const city = s.ville || s.cp;
                  const showCity = name !== city;
                  const mapsUrl = (s.lat != null && s.lon != null)
                    ? `https://maps.google.com/maps?q=${s.lat},${s.lon}`
                    : `https://maps.google.com/maps?q=${encodeURIComponent((s.adresse ? s.adresse + ', ' : '') + city)}`;
                  const d = s._dist;
                  const distStr = (d != null && d !== Infinity)
                    ? (d < 1 ? Math.round(d * 1000) + ' m' : d.toFixed(1) + ' km')
                    : '‚Äî';
                  return `
                  <tr class="border-b border-border/40 last:border-0">
                    <td class="py-2 pr-4 max-w-[180px]">
                      <div class="flex items-center gap-1">
                        <div class="min-w-0">
                          <p class="text-gray-300 truncate leading-snug">${esc(name)}</p>
                          ${showCity ? `<p class="text-gray-600 truncate leading-none mt-0.5" style="font-size:0.65rem">${esc(city)}</p>` : ''}
                        </div>
                        <a href="${esc(mapsUrl)}" target="_blank" rel="noopener"
                           class="shrink-0 ml-1 text-gray-600 hover:text-indigo-400 transition-colors" title="Google Maps">
                          <svg width="11" height="11" fill="currentColor" viewBox="0 0 24 24"><path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/></svg>
                        </a>
                      </div>
                    </td>
                    ${hasGeo ? `<td class="py-2 pr-3 text-gray-500 text-right whitespace-nowrap">${distStr}</td>` : ''}
                    ${TYPES.map(t => `<td class="py-2 pr-3 tabular-nums ${s.prix[t] ? 'text-white' : 'text-gray-600'}">${fmtFuelPrice(s.prix[t])}</td>`).join('')}
                  </tr>`;
                }).join('')}
              </tbody>
            </table>
          </div>`;
        return;
      }

      // Vue compacte (mode comparaison)
      const COMPACT = ['SP95', 'Gazole', 'E10'];
      const nearest = stations.slice(0, 6);
      const rows = COMPACT.map(t => {
        const prices = nearest.map(s => s.prix[t]).filter(v => v != null && v > 0);
        if (!prices.length) return '';
        const avg = prices.reduce((a, b) => a + b, 0) / prices.length;
        return `<span class="inline-flex items-center gap-1 text-xs"><span class="text-gray-500">${t}</span><strong class="text-white">${fmtFuelPrice(avg)}</strong></span>`;
      }).filter(Boolean);

      el.innerHTML = rows.length
        ? `<div class="flex flex-wrap gap-x-4 gap-y-1">${rows.join('')}</div>`
        : `<p class="text-xs text-gray-500">Aucune donn√©e.</p>`;

    } catch (_) {
      el.innerHTML = `<p class="text-xs text-gray-500">Indisponible.</p>`;
    }
  }

  // ‚îÄ‚îÄ Amazon affili√© ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function buildAmazonBlock(c, ctx) {
    const AMZN = `https://www.amazon.fr/s?tag=${AMZN_TAG}&k=`;
    let items = [];

    if (ctx === 'compare') {
      items = [
        { icon: 'üì¶', label: 'Cartons & √©quipement d√©m√©nagement', q: 'cartons+d√©m√©nagement+kit' },
        { icon: 'üìã', label: 'Guides immobilier & investissement', q: 'guide+investissement+immobilier+france' },
        { icon: 'üîå', label: 'Multiprises & connectivit√© maison',  q: 'multiprise+connect√©e+smart' },
      ];
    } else if (c) {
      const pop = c.population || 0;
      const fibre = c.fibre_pct;
      const prixM2 = c.immo?.prix_m2_median;
      if (pop >= 50000) {
        items.push({ icon: 'üö≤', label: 'V√©los √©lectriques & mobilit√© urbaine', q: 'v√©lo+√©lectrique+urbain' });
        items.push({ icon: 'üè†', label: 'Meubles & optimisation appartement',   q: 'meuble+gain+place+appartement' });
      } else if (pop >= 5000) {
        items.push({ icon: 'üåø', label: 'Jardinage & am√©nagement ext√©rieur',    q: 'jardinage+terrasse+outillage' });
        items.push({ icon: 'üîß', label: 'Outillage & bricolage maison',         q: 'perceuse+visseuse+bricolage' });
      } else {
        items.push({ icon: '‚òÄÔ∏è', label: 'Panneaux solaires & autonomie',        q: 'panneau+solaire+maison+autonomie' });
        items.push({ icon: 'üå±', label: 'Potager & graines bio',                q: 'potager+graines+permaculture' });
      }
      if (fibre != null && fibre < 50) {
        items.push({ icon: 'üì°', label: 'Routeurs 4G/5G zones rurales',         q: 'routeur+4G+5G+maison+rural' });
      } else {
        items.push({ icon: 'üíª', label: 'Box fibre & Wi-Fi 6 haut d√©bit',       q: 'routeur+wifi+6+mesh+fibre' });
      }
      if (prixM2 && prixM2 > 3500) {
        items.push({ icon: 'üìö', label: 'Guides investissement immobilier',      q: 'guide+investissement+immobilier+locatif' });
      }
    }

    if (!items.length) return '';
    const cols = Math.min(items.length, 3);
    return `
    <div class="amzn-card rounded-2xl p-5 mb-4">
      <div class="flex items-center gap-2 mb-3">
        <span class="text-amber-400 text-sm font-bold">‚òÖ</span>
        <h2 class="text-sm font-semibold text-white">√âquipement recommand√© pour votre installation</h2>
        <span class="badge bg-amber-500/20 text-amber-300 ml-auto">Amazon</span>
      </div>
      <div class="grid grid-cols-1 sm:grid-cols-${cols} gap-2">
        ${items.map(it => `
        <a href="${AMZN}${encodeURIComponent(it.q)}" target="_blank" rel="noopener sponsored"
           class="flex items-center gap-2.5 bg-black/20 hover:bg-black/40 border border-amber-500/10 hover:border-amber-500/30 rounded-xl px-3 py-2.5 transition-all group">
          <span class="text-lg shrink-0">${it.icon}</span>
          <span class="text-xs text-gray-300 group-hover:text-white transition-colors leading-snug">${it.label}</span>
          <svg class="ml-auto shrink-0 opacity-40 group-hover:opacity-80" width="10" height="10" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path d="M7 7h10v10M7 17 17 7"/></svg>
        </a>`).join('')}
      </div>
      <p class="text-xs text-gray-600 mt-2">Liens d'affiliation Amazon (vivrea-21).</p>
    </div>`;
  }

  // ‚îÄ‚îÄ Fetch helpers ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchByInsee(code) {
    // Force String pour √©viter tout conflit String vs Number
    const codeStr = String(code).trim().padStart(5, '0');
    console.log('[Vivre√Ä] fetchByInsee :', codeStr, '(type entr√©e:', typeof code, ')');

    const dep = codeStr.startsWith('97') ? codeStr.slice(0, 3) : codeStr.slice(0, 2);
    const details = await fetchDep(dep);

    if (details) {
      // String(c.code_insee) === String(codeStr) ‚Äî comparaison forc√©e en String
      const found = details.find(c => String(c.code_insee) === codeStr);
      if (found) {
        console.log('[Vivre√Ä] Trouv√© dans dept', dep, ':', found.nom);
        return enrich(found);
      }
      console.log('[Vivre√Ä] Non trouv√© dans dept', dep, '‚Äî fallback API G√©o');
    }

    // Fallback API G√©o
    const raw = await fetchJSON(
      `https://geo.api.gouv.fr/communes/${codeStr}?fields=code,nom,codesPostaux,codeDepartement,population,surface,centre`
    );
    return raw?.code ? enrich(geoMap(raw)) : null;
  }

  async function fetchBySlug(slug) {
    const nom  = slug.replace(/-/g, ' ');
    const list = await fetchJSON(
      `https://geo.api.gouv.fr/communes?nom=${encodeURIComponent(nom)}&fields=code,nom,codesPostaux,codeDepartement,population,surface,centre&limit=1`
    );
    if (!list?.length) return null;
    const codeStr = String(list[0].code).padStart(5, '0');
    const dep     = list[0].codeDepartement;
    const details = await fetchDep(dep);
    const found   = details?.find(c => String(c.code_insee) === codeStr);
    return enrich(found || geoMap(list[0]));
  }

  async function fetchDep(dep) {
    if (dep in depCache) return depCache[dep];
    depCache[dep] = await fetchJSON(`${DATA_BASE}/details/${dep}.json`);
    return depCache[dep];
  }

  function geoMap(c) {
    const coords = c.centre?.coordinates || [null, null];
    return {
      code_insee:    String(c.code).padStart(5, '0'),
      nom:           c.nom,
      codes_postaux: (c.codesPostaux || []).map(String),
      cp:            String((c.codesPostaux || [])[0] || ''),
      code_dep:      String(c.codeDepartement || ''),
      population:    c.population || 0,
      surface_km2:   c.surface ? Math.round(c.surface / 100) : null,
      lat: coords[1], lon: coords[0],
    };
  }

  function enrich(c) {
    if (!c) return null;
    c.code_insee = String(c.code_insee).padStart(5, '0');   // garantit String 5 chars
    if (!c.cp) c.cp = String((c.codes_postaux || [])[0] || '');
    return c;
  }

  // ‚îÄ‚îÄ Pages statiques / 404 ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function renderStatic(container, tplId, title) {
    setSEO(title, '', BASE_URL + location.pathname);
    const tpl = document.getElementById(tplId);
    if (tpl) container.appendChild(tpl.content.cloneNode(true));
  }

  function render404(container) {
    setSEO('Page introuvable ‚Äì Vivre√Ä', '', BASE_URL + '/');
    container.innerHTML = `
      <div class="text-center py-24 fade-up">
        <p class="text-7xl font-black text-gray-800 mb-4">404</p>
        <p class="text-gray-400 mb-8">Cette page n'existe pas.</p>
        <button onclick="navigate('/',event)" class="bg-indigo-600 hover:bg-indigo-500 text-white text-sm px-6 py-2.5 rounded-xl transition-colors">Retour √† l'accueil</button>
      </div>`;
  }

  // ‚îÄ‚îÄ SEO ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  function setSEO(title, desc, canonical) {
    document.title = title;
    const setMeta = (attr, name, val) => {
      let el = document.querySelector(`meta[${attr}="${name}"]`);
      if (!el) { el = document.createElement('meta'); el.setAttribute(attr, name); document.head.appendChild(el); }
      el.setAttribute('content', val);
    };
    setMeta('name',     'description',    desc);
    setMeta('property', 'og:title',       title);
    setMeta('property', 'og:description', desc);
    setMeta('property', 'og:url',         canonical);
    const link = document.querySelector('link[rel="canonical"]');
    if (link) link.href = canonical;
  }

  // ‚îÄ‚îÄ Utils ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  async function fetchJSON(url) {
    try { const r = await fetch(url, { cache: 'no-store' }); return r.ok ? r.json() : null; }
    catch { return null; }
  }

  function esc(s) {
    if (s == null) return '';
    return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function fmtPop(n) {
    if (!n) return '';
    if (n >= 1e6) return (n / 1e6).toFixed(1) + 'M';
    if (n >= 1000) return Math.round(n / 1000) + 'k';
    return String(n);
  }

  function highlight(text, query) {
    const safe = esc(text);
    const q = query.trim().replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
    if (!q) return safe;
    return safe.replace(new RegExp(`(${q})`, 'gi'), '<mark class="bg-indigo-500/30 text-indigo-200 rounded px-0.5">$1</mark>');
  }

  function copyInsee(code) {
    navigator.clipboard?.writeText(code).then(() => {
      const btn = document.getElementById('btn-copy-insee');
      if (btn) { const o = btn.textContent; btn.textContent = 'Copi√© !'; setTimeout(() => btn.textContent = o, 1500); }
    });
  }

  // ‚îÄ‚îÄ Boot ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  (function boot() {
    const redirect = sessionStorage.getItem('spa_redirect');
    if (redirect) { sessionStorage.removeItem('spa_redirect'); history.replaceState(null, '', redirect); }
    initWorker();
    loadIndex();
    route(location.pathname);
  })();
  </script>
  <script src="/fuel.js"></script>
</body>
</html>
